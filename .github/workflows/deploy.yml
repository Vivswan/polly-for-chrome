name: Deploy and Release

on:
  push:
    branches: [ deploy ]

permissions:
  contents: write
  id-token: write
  pull-requests: write
  pages: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "deploy"
  cancel-in-progress: false

jobs:
  test:
    uses: ./.github/workflows/test-reusable.yml
    with:
      ref: deploy

  build-and-release:
    needs: [ test ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout deploy branch
        uses: actions/checkout@v6
        with:
          ref: deploy

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Extract version from package.json
      - name: Get version from package.json
        id: version
        run: |
          PACKAGE_VERSION=$(cat package.json | grep version | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d ' ')
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Version from package.json: $PACKAGE_VERSION"

      # Create extension private key file if secret exists
      - name: Create extension private key file
        if: "${{ env.EXTENSION_PRIVATE_KEY != '' }}"
        env:
          EXTENSION_PRIVATE_KEY: ${{ secrets.EXTENSION_PRIVATE_KEY }}
        run: |
          echo "$EXTENSION_PRIVATE_KEY" > key.pem
          echo "Private key configured"

      # Build the extension
      - name: Build the extension
        run: bun run build

      # Verify the build output directory exists
      - name: Verify build output
        run: |
          ls -la builds/
          echo "Build artifacts ready for release"

      # Create GitHub release with both files if CRX exists
      - name: Create GitHub Release with CRX
        id: create_release_with_crx
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Polly For Chrome v${{ steps.version.outputs.version }}
          body: |
            ## Polly For Chrome v${{ steps.version.outputs.version }}
            
            ### Installation
            1. Download the zip file
            2. Extract the contents
            3. Go to chrome://extensions
            4. Enable "Developer mode"
            5. Click "Load unpacked" and select the extracted folder
            
            [Full documentation](https://github.com/Vivswan/polly-for-chrome#readme)
          files: |
            builds/polly-for-chrome-v${{ steps.version.outputs.version }}.zip
            builds/polly-for-chrome-v${{ steps.version.outputs.version }}.crx
          draft: false
          prerelease: false
        env:
          VERSION: ${{ steps.version.outputs.version }}
          CRX_EXISTS: ${{ steps.check_crx.outputs.crx_exists }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: './dist'

  deploy:
    needs: build-and-release
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  bump-version:
    needs: build-and-release
    uses: ./.github/workflows/bump-version-reusable.yml